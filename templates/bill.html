{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% load crispy_forms_tags %}

{% block navbar-center %}
<div class="row">
	{% if bill.owner %}
	<div class="col-12">
		<h4 class="text-center">{% trans " Bill " %} {{ bill.code }}  {% trans " of customer " %} {{ bill.owner }}
		{% if bill.owner.saves_paper %}
		<a class="btn bg-transparent" data-toggle="tooltip" data-bs-placement="top" title="Customer prefers electronic receipts" >
		<img class="img-fluid" src="{% static 'site/ico/GreenLeaf.svg' %}" style="max-width:50px;" /> 
		</a>
		{% endif%}
		</h4>
	</div>
	{% else %}
	<div class="col-7">
		<h4 class="text-center">{% trans " Assign customer to bill "  %}{{ bill.code }}</h4>
	</div>
	<div class="col-3">
		<form action="{% url 'MaterialsAPP_assign_customer' code=bill.code %}" method="post">
				{% csrf_token %}
				{{ findCustomerForm.data }}
				<input type="submit" hidden />
		</form>
	</div>
	<div class="col-2">
	</div>
	{% endif %}
</div>
{% endblock %}

{% block container %}

<div class="row flex-nowrap px-5">
	<div class="col-9">
		<div class="d-flex">
			<div class="nav flex-column w-15 nav-pills me-3" id="v-pills-tab2" role="tablist" aria-orientation="vertical">
				{% for tab in productfamilies_tabs %}
				<a class="nav-link {% if tab.active %} active {% endif %}" id="v-pills-products{{ tab.id }}-tab" data-bs-toggle="pill" data-bs-target="#v-pills-products{{ tab.id }}" type="button" role="tab" aria-controls="v-pills-products{{ tab.id }}" aria-selected="{% if tab.active %} true {% else %} false {% endif %} ">
					{{ tab.name }}
				</a>
				{% endfor %}
			</div>
			<div class="tab-content" id="v-pills-tabContent2">
				{% for tab in productfamilies_tabs %}
				<div class="tab-pane fade show {% if tab.active %} active {% endif %}" id="v-pills-products{{ tab.id }}" role="tabpanel" aria-labelledby="v-pills-products{{ tab.id }}-tab">
					<div class="card-group">
						{% for product in tab.items|slice:"0:8" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"8:16" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"16:24" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"24:32" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"32:40" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"40:48" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"48:56" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"56:64" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"64:72" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"72:80" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"80:88" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"88:96" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
					<div class="card-group">
						{% for product in tab.items|slice:"96:104" %}	
						{% include "ProductsAPP/_product_card.html" %}			
						{% endfor %}
					</div>
				</div>
				{% endfor %}
			</div>
		</div>
	</div>
	<div class="col-3 px-sm-2 px-0 bg-dark">
		<div class="d-flex flex-column align-items-center align-items-sm-start px-3 pt-2 text-white min-vh-100">
			<div class='col-12'>
				<form action="{% url 'MaterialsAPP_append_barcode_to_bill' code=bill.code %}" method="post">
						{% csrf_token %}
						{{ barcode2BillForm|crispy }}
						<input type="submit" hidden />
				</form>
			</div>
			<script>
				setInterval(function(){
					const activeElement = document.activeElement;
					if (activeElement != document.getElementById("id_customer_data")){document.getElementById("id_barcode").focus();}
				}, 500);				
			</script>
			<div class='col-12'>
				{% if bill.bill_positions.count > 0 %}
				<h5>{{ bill.bill_positions.count }} {% trans " position" %}{{ bill.bill_positions.count|pluralize }}</h5>
				{% endif %}
			</div>
			<table class="table table-dark" id="bill_table">
				<thead>
					<tr>
						<th scope="col">{% trans "Units" %}</th>
						<th scope="col">{% trans "Product" %}</th>
						<th scope="col">{% trans "Price" %}</th>
						<th scope="col">{% trans "Subtotal" %}</th>
						<th scope="col">{% trans "X" %}</th>
					</tr>
				</thead>
				<tbody>	
					{% for row in bill.bill_positions.all %}
					<tr> 
						<td>{{ row.quantity }}</td>
						<td>{{ row.product }} <br> {% if row.reduce_concept %}{{ row.reduce_concept }} {% endif %} </td>
						<td>{{ row.product.pvp }} €</td>
						<td>{{ row.getSubtotal }} €</td>
						<td>
							<a type="button" class="btn btn-primary col-12" href={% url 'MaterialsAPP_reduce_bill_position' id=row.id %}>
								-
							</a>
						</td>
					</tr>
					{% endfor %}
					{% if bill.userDiscount %}
					<tr> 
						<td colspan=3>
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-award" viewBox="0 0 16 16">
								<path d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702z"/>
								<path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1z"/>
							</svg>
							{% trans "User discount " %} {{ bill.userDiscount }} %
						</td>
						<td>-{{ bill.userDiscountAmount }} €</td>
					</tr>
					{% endif %}
					{% if bill.userCredit %}
					<tr> 
						<td colspan=3>
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-coin" viewBox="0 0 16 16">
								<path d="M5.5 9.511c.076.954.83 1.697 2.182 1.785V12h.6v-.709c1.4-.098 2.218-.846 2.218-1.932 0-.987-.626-1.496-1.745-1.76l-.473-.112V5.57c.6.068.982.396 1.074.85h1.052c-.076-.919-.864-1.638-2.126-1.716V4h-.6v.719c-1.195.117-2.01.836-2.01 1.853 0 .9.606 1.472 1.613 1.707l.397.098v2.034c-.615-.093-1.022-.43-1.114-.9zm2.177-2.166c-.59-.137-.91-.416-.91-.836 0-.47.345-.822.915-.925v1.76h-.005zm.692 1.193c.717.166 1.048.435 1.048.91 0 .542-.412.914-1.135.982V8.518z"/>
								<path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
								<path d="M8 13.5a5.5 5.5 0 1 1 0-11 5.5 5.5 0 0 1 0 11m0 .5A6 6 0 1 0 8 2a6 6 0 0 0 0 12"/>
							</svg>
							{% trans "User credits " %}
						</td>
						<td>-{{ bill.userCredit }} €</td>
					</tr>
					{% endif %}

					<tr> 
						<td colspan=3><h5>{% trans "VAT" %}</h5></td>
						<td scope="col"><h5>{{ bill.getVATAmount }} €</h5></td>
					</tr>
					<tr> 
						<td colspan=3><h4>{% trans "TOTAL" %}</h4></td>
						<td scope="col"><h4>{{ bill.total }} €</h4></td>
					</tr>
					<tr>
						<a type="button" class="btn btn-success col-12" href={% url 'MaterialsAPP_resume_bill' code=bill.code %} >
							<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="currentColor" class="bi bi-credit-card" viewBox="0 0 16 16">
								<path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v1h14V4a1 1 0 0 0-1-1zm13 4H1v5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1z"/>
								<path d="M2 10a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1z"/>
								</svg>
							<span class="h4 text-white">{% trans " Close bill" %}</span>
						</a>
					</tr>
				</tbody>    
			</table>
			
			{% if billPos %}
			<br>
			<br>
			<h5>{{ billPos.product.name }}</h5>
			<table class="table table-dark text-center" id="multiplier_table" style="width:100%">
				<tbody>	
					<tr style="height:75px"> 
						<td class='h3' colspan=3><span id="BillPosTotalQuantity"><span></td>
					</tr>
					<tr style="height:75px"> 
						<td class='h3' onclick="appendDigit(7);" style="cursor: pointer;">7</td>
						<td class='h3' onclick="appendDigit(8);" style="cursor: pointer;">8</td>
						<td class='h3' onclick="appendDigit(9);" style="cursor: pointer;">9</td>
					</tr>
					<tr style="height:75px"> 
						<td class='h3' onclick="appendDigit(4);" style="cursor: pointer;">4</td>
						<td class='h3' onclick="appendDigit(5);" style="cursor: pointer;">5</td>
						<td class='h3' onclick="appendDigit(6);" style="cursor: pointer;">6</td>
					</tr>
					<tr style="height:75px"> 
						<td class='h3' onclick="appendDigit(1);" style="cursor: pointer;">1</td>
						<td class='h3' onclick="appendDigit(2);" style="cursor: pointer;">2</td>
						<td class='h3' onclick="appendDigit(3);" style="cursor: pointer;">3</td>
					</tr>
					<tr style="height:75px"> 
						<td class='h3' onclick="appendDigit(0);" style="cursor: pointer;">0</td>
						<td class='h3' colspan=2 onclick="correctLast();" style="cursor: pointer;"><<</td>
					</tr>
					<tr style="height:75px"> 
						<td class='h3' colspan=3 onclick="setMultiplier();" style="cursor: pointer;">{% trans "Set Value" %}</td>
					</tr>
				</tbody>    
			</table>

			
			<script>
				$.ajaxSetup({ 
					beforeSend: function(xhr, settings) {
						function getCookie(name) {
							var cookieValue = null;
							if (document.cookie && document.cookie != '') {
								var cookies = document.cookie.split(';');
								for (var i = 0; i < cookies.length; i++) {
									var cookie = jQuery.trim(cookies[i]);
									// Does this cookie string begin with the name we want?
									if (cookie.substring(0, name.length + 1) == (name + '=')) {
										cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
										break;
									}
								}
							}
							return cookieValue;
						}
						xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
					} 
				});

				let value = document.getElementById("BillPosTotalQuantity");

				function correctLast(){
					if (value.textContent.length > 1){value.textContent = value.textContent.substring(0, value.textContent.length - 1);}
					else {value.textContent = '';}
				}
				function appendDigit(digit){
					value.textContent+=digit;
				}
				function setMultiplier(){
					$.ajax({
								url: "{% url 'ProductsAPP_billPosition_setMultiplier' id=billPos.id %}",
								type: "POST",
								dataType: 'json',
								contentType: 'application/json',
								data: JSON.stringify({"value": parseInt(value.textContent) })
							}).done(function( data ) {
								if ( data ) {
									let url = data['url'];
									window.location.href=url;
								}
								//
							});
				}
			</script>
			{% endif %}
			
			<div class="col-12" id="messages_container">
				{% if messages %}
				<ul class="messages">
					{% for message in messages %}
					<li{% if message.tags %} class="alert {{ message.tags }}" {% else %} class="alert alert-danger"{% endif %}>{{ message }}</li>
					{% endfor %}
				</ul>
				{% endif %}
			</div>
		</div>
	</div>
</div>

{% endblock container %}

{% block scripts %}

{% endblock scripts %}
